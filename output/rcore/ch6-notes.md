# CH6 NOTES

FOS

## 理论

### 文件和文件系统

- 文件
  - 文件概念
  - 文件操作
    - 以 linux 为例介绍文件系统的概念
    - 从内核的角度来看，它会将所有文件无差别的看成一个字节序列，文件内容的结构和含义则是交给对应的应用进行解析
    - 绝对路径和相对路径
    - 文件系统的作用
      - 用户视角：通过路径即可索引到文件并以字节流进行读写的用户视角有很大的不同
      - 系统视角：常规文件和目录都是实际保存在持久存储设备中的。持久存储设备仅支持以扇区（或块）为单位的随机读写
      - 中间转换的便是 文件系统 (File System) - 文件系统负责将逻辑上的目录树结构（包括其中每个文件或目录的数据和其他信息）映射到持久存储设备上，决定设备上的每个扇区应存储哪些内容
    - 多种文件系统 -> 虚拟文件系统
- 文件系统
  - 文件描述符
  - 文件系统的底层实现中都是对文件进行随机读写的
  - VFS
  - 目录
  - 文件别名
  - 文件系统的挂载
  
- 文件描述符在 PCB 中的体现
- inode - 文件控制块
- 缓存置换算法
- 文件锁
- 文件内存分配
- bitmap 空闲空间管理
- 分区

### 文件磁盘缓存

### 支持崩溃一致性可靠文件系统

- fsck 解决
- 日志方式
- 支持事务

## 实践

## 文件系统的设计与实现

- 文件系统存储结构
  - superblock
  - inode
  - bitmap
  - dir_entry
- 文件系统的加载流程
- 系统调用
  - open
  - close
  - write
  - read
  - seek offset
  
## 支持文件的操作系统 - FOS

- easyfs
- LRU 缓存算法 - 为什么对内存页置换算法不可行
- 之前没有文件系统可以加载应用，现在为什么需要文件系统
- sys_read write offset 在操作系统层面保存
- 基于文件加载应用程序
- 算出能放多少文件
- 实验：文件系统支持软连接

## easy-fs

- 别注意哪些数据结构是存储在磁盘上，哪些数据结构是存储在内存中的，这样在实现的时候才不会引起混乱
- 开发方式 - 从软件层面进行抽象
  - easy-fs 为简易文件系统的核心部分，它是一个库形式 crate，实现一种简单的文件系统磁盘布局；
  - easy-fs-fuse 是一个能在开发环境（如 Ubuntu）中运行的应用程序，它可以对 easy-fs 进行测试，或者将为我们内核开发的应用打包为一个 easy-fs 格式的文件系统镜像。
  - 整个easy-fs文件系统的设计开发可以按照应用程序库的开发过程来完成 - 方便测试
- 按层开发
  - 块设备接口层 - block_dev.rs
    - read_block 将编号为 block_id 的块从磁盘读入内存中的缓冲区 buf 
    - write_block 将内存中的缓冲区 buf 中的数据写入磁盘编号为 block_id 的块
  - 块缓存层 - block_cache.rs
    - 块缓存 - block_cache
    - FnOnce 封装
    - 块缓存全局管理器 - BlockCacheManager
      - 类 FIFO 的简单缓存替换算法
      - get_block_cache
  - 磁盘数据结构层 - layout.rs | bitmap.rs
    - ![结构图](https://rcore-os.cn/rCore-Tutorial-Book-v3/_images/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80.png)
    - 结构描述 - 块编号从小到大顺序地分成 5 个不同属性的连续区域
      - Super Block - 以魔数的形式提供了文件系统合法性检查功能，同时还可以定位其他连续区域的位置
      - 索引节点位图 - 记录了后面的索引节点区域中有哪些索引节点已经被分配出去使用了，而哪些还尚未被分配出去
      - 索引节点区域 - 长度为若干个块。其中的每个块都存储了若干个索引节点
      - 数据块位图 - 长度为若干个块。它记录了后面的数据块区域中有哪些数据块已经被分配出去使用了，而哪些还尚未被分配出去
      - 数据块区域，顾名思义，其中的每一个已经分配出去的块保存了文件或目录中的具体数据内容
    - 位图
      - 每个 bit 都代表一个索引节点/数据块的分配状态， 0 意味着未分配，而 1 则意味着已经分配出去
    - 磁盘上索引节点 - DiskInode
      - 每个文件/目录在磁盘上均以一个 DiskInode 的形式存储。其中包含文件/目录的元数据： size 表示文件/目录内容的字节数， type_ 表示索引节点的类型 DiskInodeType ，目前仅支持文件 File 和目录 Directory 两种类型。其余的 direct/indirect1/indirect2 都是存储文件内容/目录内容的数据块的索引，这也是索引节点名字的由来
    - 数据块与目录项
      - 我们需要将目录项转化为缓冲区（即字节切片）的形式来符合索引节点 Inode 数据结构中的 read_at 或 write_at 方法接口的要求
  - 磁盘块管理器层 - efs.rs - 将各段区域及上面的磁盘数据结构整合起来就是简易文件系统 EasyFileSystem 的职责
    - EasyFileSystem 包含索引节点和数据块的两个位图 inode_bitmap 和 data_bitmap
    - 还记录下索引节点区域和数据块区域起始块编号方便确定每个索引节点和数据块在磁盘上的具体位置
    - 块设备的一个指针 block_device
  - 索引节点层 DiskINode -> VINode -> OSINode
    - DiskInode 放在磁盘块中比较固定的位置，而 Inode 是放在内存中的记录文件索引节点信息的数据结构
    - 文件索引 - 文件列举 - 文件创建 - 文件清空 - 文件读写
- 实现二级制打包工具

## rcore 接入 easy-fs

- 块设备驱动层
- easy-fs 层
- 内核索引节点层
- 文件描述符层
- 系统调用层